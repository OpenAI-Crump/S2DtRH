<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Info</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
</head>
<body>

<div class="container">

    <div id="no-device" class="card hidden">
        <p>Scan the QR code on the device to view its info.</p>
        <button id="scan-btn" class="scan-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 7V5a2 2 0 0 1 2-2h2"/>
                <path d="M17 3h2a2 2 0 0 1 2 2v2"/>
                <path d="M21 17v2a2 2 0 0 1-2 2h-2"/>
                <path d="M7 21H5a2 2 0 0 1-2-2v-2"/>
                <rect x="7" y="7" width="10" height="10" rx="1"/>
            </svg>
            Scan QR code
        </button>
        <div id="scanner-container" class="hidden">
            <div id="qr-reader"></div>
            <button id="scan-stop-btn" class="scan-stop-btn">Cancel</button>
        </div>
    </div>

    <div id="auth-gate" class="card hidden">
        <p>Enter the code to go down the rabbit hole.</p>
        <form id="code-form">
            <input
                type="text"
                id="code-input"
                maxlength="5"
                placeholder="*****"
                autocomplete="off"
                inputmode="text"
            >
            <button type="submit" id="code-submit">ENTER</button>
        </form>
        <p id="code-error" class="error hidden">Wrong code. Try again.</p>
    </div>

    <div id="device-content" class="card hidden">
        <h1 id="device-title"></h1>
        <div id="device-text"></div>
        <div id="device-actions" class="device-actions hidden">
            <a id="inventory-btn" href="#" target="_blank" class="action-btn hidden">Show in inventory</a>
            <a id="dell-btn" href="#" target="_blank" class="action-btn hidden">Show in Dell support</a>
        </div>
    </div>

    <div id="device-not-found" class="card hidden">
        <p>Device not found. Check the QR code or contact the administrator.</p>
    </div>

</div>

<script src="crypto.js"></script>
<script>
(function () {
    "use strict";

    var params = new URLSearchParams(window.location.search);
    var deviceId = params.get("id");

    var elNoDevice = document.getElementById("no-device");
    var elAuthGate = document.getElementById("auth-gate");
    var elContent = document.getElementById("device-content");
    var elNotFound = document.getElementById("device-not-found");
    var elCodeForm = document.getElementById("code-form");
    var elCodeInput = document.getElementById("code-input");
    var elCodeError = document.getElementById("code-error");
    var elDeviceTitle = document.getElementById("device-title");
    var elDeviceText = document.getElementById("device-text");
    var elDeviceActions = document.getElementById("device-actions");
    var elInventoryBtn = document.getElementById("inventory-btn");
    var elDellBtn = document.getElementById("dell-btn");

    function show(el) { el.classList.remove("hidden"); }
    function hide(el) { el.classList.add("hidden"); }

    function getExpectedCode() {
        var now = new Date();
        var parts = new Intl.DateTimeFormat("cs-CZ", {
            timeZone: "Europe/Prague",
            year: "2-digit",
            month: "2-digit"
        }).formatToParts(now);

        var year = "";
        var month = "";
        for (var i = 0; i < parts.length; i++) {
            if (parts[i].type === "year") year = parts[i].value;
            if (parts[i].type === "month") month = parts[i].value;
        }
        return year + month + "#";
    }

    function loadDevice(id) {
        var url = "devices/" + encodeURIComponent(id) + ".txt";
        var xhr = new XMLHttpRequest();
        xhr.open("GET", url, true);
        xhr.onload = function () {
            if (xhr.status === 200) {
                var raw = xhr.responseText.trim();
                Promise.resolve().then(function () {
                    return S2DtRH.decrypt(raw);
                }).catch(function () {
                    return raw;
                }).then(function (text) {
                    var device = S2DtRH.parseDeviceData(text);
                    elDeviceTitle.textContent = id;
                    elDeviceText.innerHTML = S2DtRH.formatText(device.content);
                    var hasActions = false;
                    if (device.inventoryLink) {
                        elInventoryBtn.href = device.inventoryLink;
                        show(elInventoryBtn);
                        hasActions = true;
                    }
                    if (device.serviceTag) {
                        elDellBtn.href = "https://www.dell.com/support/product-details/en-us/servicetag/" + encodeURIComponent(device.serviceTag);
                        show(elDellBtn);
                        hasActions = true;
                    }
                    if (hasActions) show(elDeviceActions);
                    show(elContent);
                });
            } else {
                show(elNotFound);
            }
        };
        xhr.onerror = function () {
            show(elNotFound);
        };
        xhr.send();
    }

    if (!deviceId) {
        show(elNoDevice);

        var elScanBtn = document.getElementById("scan-btn");
        var elScannerContainer = document.getElementById("scanner-container");
        var elScanStopBtn = document.getElementById("scan-stop-btn");
        var scanner = null;

        elScanBtn.addEventListener("click", function () {
            hide(elScanBtn);
            show(elScannerContainer);
            scanner = new Html5Qrcode("qr-reader");
            scanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                function (decodedText) {
                    scanner.stop().then(function () { scanner = null; });
                    try {
                        var url = new URL(decodedText);
                        var id = url.searchParams.get("id");
                        if (id) {
                            window.location.href = url.href;
                            return;
                        }
                    } catch (e) {}
                    window.location.href = decodedText;
                }
            ).catch(function () {
                hide(elScannerContainer);
                show(elScanBtn);
                alert("Camera access denied or not available.");
            });
        });

        elScanStopBtn.addEventListener("click", function () {
            if (scanner) {
                scanner.stop().then(function () {
                    scanner = null;
                    hide(elScannerContainer);
                    show(elScanBtn);
                });
            } else {
                hide(elScannerContainer);
                show(elScanBtn);
            }
        });

        return;
    }

    if (!/^[a-zA-Z0-9_\-]+$/.test(deviceId)) {
        show(elNoDevice);
        return;
    }

    show(elAuthGate);
    elCodeInput.focus();

    elCodeForm.addEventListener("submit", function (e) {
        e.preventDefault();
        var entered = elCodeInput.value.trim();
        var expected = getExpectedCode();

        if (entered === expected) {
            hide(elAuthGate);
            hide(elCodeError);
            loadDevice(deviceId);
        } else {
            show(elCodeError);
            elCodeInput.value = "";
            elCodeInput.focus();
        }
    });
})();
</script>

</body>
</html>
