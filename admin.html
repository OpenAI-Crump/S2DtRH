<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin – Device Info</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>

<div class="container admin-container">

    <!-- Login -->
    <div id="admin-login" class="card">
        <h1>Administrace</h1>
        <p>Přihlaste se pro správu zařízení.</p>
        <form id="login-form" class="admin-form">
            <input type="password" id="admin-pass" placeholder="Heslo administrátora" autocomplete="off">
            <input type="text" id="github-pat" placeholder="GitHub Personal Access Token" autocomplete="off">
            <button type="submit">Přihlásit</button>
        </form>
        <p id="login-error" class="error hidden">Neplatné heslo nebo PAT.</p>
    </div>

    <!-- Device list -->
    <div id="admin-panel" class="card hidden">
        <div class="panel-header">
            <h1>Zařízení</h1>
            <button id="new-device-btn" class="btn-small">+ Nové</button>
        </div>
        <div id="device-list"></div>
        <p id="list-empty" class="hint hidden">Žádná zařízení. Přidejte první.</p>
        <p id="list-error" class="error hidden"></p>
        <div class="panel-actions">
            <button id="export-btn" class="btn-export hidden">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M8 2v8m0 0L5 7m3 3 3-3"/>
                    <path d="M2 11v2a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-2"/>
                </svg>
                Export zálohy (.zip)
            </button>
            <button id="import-btn" class="btn-export hidden">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M8 10V2m0 0L5 5m3-3 3 3"/>
                    <path d="M2 11v2a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-2"/>
                </svg>
                Import zálohy (.zip)
            </button>
            <input type="file" id="import-file" accept=".zip" class="hidden">
        </div>
    </div>

    <!-- Editor -->
    <div id="editor" class="card hidden">
        <h1 id="editor-title">Nové zařízení</h1>
        <form id="editor-form" class="admin-form">
            <label for="device-id-input">ID zařízení</label>
            <input type="text" id="device-id-input" placeholder="napr. cerpadlo-A-S04" autocomplete="off">
            <label for="device-content">Obsah</label>
            <textarea id="device-content" rows="10" placeholder="Text zařízení..."></textarea>
            <label for="inventory-link-input">Odkaz na inventář (volitelné)</label>
            <input type="url" id="inventory-link-input" placeholder="https://sharepoint.com/..." autocomplete="off">
            <label for="service-tag-input">Dell Service Tag (volitelné)</label>
            <input type="text" id="service-tag-input" placeholder="např. 8TFD1D4" autocomplete="off">
        </form>
        <p class="hint">Text mezi _podtržítky_ se zobrazí <strong>tučně</strong>.</p>
        <div id="preview-box">
            <div class="preview-label">Náhled</div>
            <div id="preview-text"></div>
        </div>
        <div class="editor-actions">
            <button id="save-btn">Uložit</button>
            <button id="delete-btn" class="btn-danger hidden">Smazat</button>
            <button id="back-btn" class="btn-secondary">Zpět</button>
        </div>
        <div id="device-link-box" class="device-link-box hidden">
            <div class="preview-label">Odkaz na zařízení</div>
            <div class="device-link-row">
                <a id="device-link" href="#" target="_blank" class="device-link"></a>
                <button id="copy-link-btn" type="button" class="copy-btn" title="Kopírovat do schránky">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="5.5" y="5.5" width="8" height="8" rx="1.5"/>
                        <path d="M10.5 5.5V3a1.5 1.5 0 0 0-1.5-1.5H3A1.5 1.5 0 0 0 1.5 3v6A1.5 1.5 0 0 0 3 10.5h2.5"/>
                    </svg>
                </button>
            </div>
        </div>
        <p id="editor-status" class="hidden"></p>
    </div>

</div>

<script src="crypto.js"></script>
<script>
(function () {
    "use strict";

    var githubPat = "";
    var editingSha = null;
    var editingName = "";

    var elLogin = document.getElementById("admin-login");
    var elLoginForm = document.getElementById("login-form");
    var elAdminPass = document.getElementById("admin-pass");
    var elGithubPat = document.getElementById("github-pat");
    var elLoginError = document.getElementById("login-error");

    var elPanel = document.getElementById("admin-panel");
    var elDeviceList = document.getElementById("device-list");
    var elListEmpty = document.getElementById("list-empty");
    var elListError = document.getElementById("list-error");
    var elNewBtn = document.getElementById("new-device-btn");
    var elExportBtn = document.getElementById("export-btn");
    var elImportBtn = document.getElementById("import-btn");
    var elImportFile = document.getElementById("import-file");

    var elEditor = document.getElementById("editor");
    var elEditorTitle = document.getElementById("editor-title");
    var elDeviceIdInput = document.getElementById("device-id-input");
    var elDeviceContent = document.getElementById("device-content");
    var elInventoryLink = document.getElementById("inventory-link-input");
    var elServiceTag = document.getElementById("service-tag-input");
    var elPreviewText = document.getElementById("preview-text");
    var elSaveBtn = document.getElementById("save-btn");
    var elDeleteBtn = document.getElementById("delete-btn");
    var elBackBtn = document.getElementById("back-btn");
    var elEditorStatus = document.getElementById("editor-status");
    var elDeviceLinkBox = document.getElementById("device-link-box");
    var elDeviceLink = document.getElementById("device-link");
    var elCopyLinkBtn = document.getElementById("copy-link-btn");

    function show(el) { el.classList.remove("hidden"); }
    function hide(el) { el.classList.add("hidden"); }

    function showStatus(msg, isError) {
        elEditorStatus.textContent = msg;
        elEditorStatus.className = isError ? "error" : "success";
        show(elEditorStatus);
        if (!isError) setTimeout(function () { hide(elEditorStatus); }, 3000);
    }

    function apiUrl(path) {
        return "https://api.github.com/repos/" + S2DtRH.GITHUB_OWNER + "/" + S2DtRH.GITHUB_REPO + "/contents/" + path;
    }

    function apiFetch(path, options) {
        options = options || {};
        options.headers = options.headers || {};
        options.headers["Authorization"] = "token " + githubPat;
        options.headers["Accept"] = "application/vnd.github.v3+json";
        if (options.body) options.headers["Content-Type"] = "application/json";
        return fetch(apiUrl(path), options);
    }

    function loadDeviceList() {
        hide(elListEmpty);
        hide(elListError);
        hide(elExportBtn);
        hide(elImportBtn);
        elDeviceList.innerHTML = '<p class="hint">Načítání...</p>';

        apiFetch("devices").then(function (r) {
            if (r.status === 404) return [];
            return r.json();
        }).then(function (files) {
            if (!Array.isArray(files)) files = [];
            var devices = files.filter(function (f) {
                return f.name.endsWith(".txt");
            });

            elDeviceList.innerHTML = "";

            if (devices.length === 0) {
                show(elListEmpty);
                show(elImportBtn);
                return;
            }

            devices.forEach(function (f) {
                var name = f.name.replace(/\.txt$/, "");
                var item = document.createElement("div");
                item.className = "device-list-item";
                item.textContent = name;
                item.addEventListener("click", function () {
                    openEditor({ name: name, sha: f.sha });
                });
                elDeviceList.appendChild(item);
            });

            show(elExportBtn);
            show(elImportBtn);
        }).catch(function (err) {
            elDeviceList.innerHTML = "";
            elListError.textContent = "Chyba: " + err.message;
            show(elListError);
        });
    }

    function decodeFileContent(data) {
        var binary = atob(data.content.replace(/\s/g, ""));
        var bytes = new Uint8Array(binary.length);
        for (var i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
        var raw = new TextDecoder("utf-8").decode(bytes);
        return Promise.resolve().then(function () {
            return S2DtRH.decrypt(raw.trim());
        }).catch(function () {
            return raw;
        });
    }

    function openEditor(dev) {
        hide(elPanel);
        show(elEditor);
        hide(elEditorStatus);
        elInventoryLink.value = "";
        elServiceTag.value = "";

        if (dev) {
            elEditorTitle.textContent = "Upravit: " + dev.name;
            elDeviceIdInput.value = dev.name;
            elDeviceIdInput.readOnly = true;
            editingSha = dev.sha;
            editingName = dev.name;
            show(elDeleteBtn);

            elDeviceContent.value = "Načítání...";
            elDeviceContent.disabled = true;
            updateDeviceLink();

            apiFetch("devices/" + dev.name + ".txt").then(function (r) {
                if (!r.ok) throw new Error("HTTP " + r.status);
                return r.json();
            }).then(function (data) {
                editingSha = data.sha;
                if (!data.content) throw new Error("Prázdný soubor");
                return decodeFileContent(data);
            }).then(function (plaintext) {
                var device = S2DtRH.parseDeviceData(plaintext);
                elDeviceContent.value = device.content;
                elInventoryLink.value = device.inventoryLink;
                elServiceTag.value = device.serviceTag;
                elDeviceContent.disabled = false;
                updatePreview();
            }).catch(function (err) {
                elDeviceContent.value = "";
                elDeviceContent.disabled = false;
                showStatus("Nepodařilo se načíst: " + err.message, true);
            });
        } else {
            elEditorTitle.textContent = "Nové zařízení";
            elDeviceIdInput.value = "";
            elDeviceIdInput.readOnly = false;
            elDeviceContent.value = "";
            elDeviceContent.disabled = false;
            editingSha = null;
            editingName = "";
            hide(elDeleteBtn);
            updatePreview();
            updateDeviceLink();
        }
    }

    function updatePreview() {
        elPreviewText.innerHTML = S2DtRH.formatText(elDeviceContent.value);
    }

    function updateDeviceLink() {
        var id = elDeviceIdInput.value.trim();
        if (id && /^[a-zA-Z0-9_\-]+$/.test(id)) {
            var url = window.location.origin + "/?id=" + encodeURIComponent(id);
            elDeviceLink.href = url;
            elDeviceLink.textContent = url;
            show(elDeviceLinkBox);
        } else {
            hide(elDeviceLinkBox);
        }
    }

    function closeEditor() {
        hide(elEditor);
        show(elPanel);
        loadDeviceList();
    }

    // Save
    elSaveBtn.addEventListener("click", function () {
        var id = elDeviceIdInput.value.trim();
        var content = elDeviceContent.value;
        var inventoryLink = elInventoryLink.value.trim();
        var serviceTag = elServiceTag.value.trim();

        if (!id) { showStatus("Zadejte ID zařízení.", true); return; }
        if (!/^[a-zA-Z0-9_\-]+$/.test(id)) {
            showStatus("ID může obsahovat pouze písmena, čísla, pomlčky a podtržítka.", true);
            return;
        }
        if (!content.trim()) { showStatus("Obsah nesmí být prázdný.", true); return; }

        elSaveBtn.disabled = true;
        elSaveBtn.textContent = "Ukládání...";

        var deviceData = S2DtRH.serializeDeviceData(content, inventoryLink, serviceTag);

        S2DtRH.encrypt(deviceData).then(function (encrypted) {
            var body = {
                message: (editingSha ? "Update " : "Create ") + id + ".txt",
                content: btoa(encrypted)
            };
            if (editingSha) body.sha = editingSha;

            return apiFetch("devices/" + id + ".txt", {
                method: "PUT",
                body: JSON.stringify(body)
            });
        }).then(function (r) {
            return r.json();
        }).then(function (data) {
            if (data.content) {
                editingSha = data.content.sha;
                editingName = id;
                elDeviceIdInput.readOnly = true;
                show(elDeleteBtn);
                showStatus("Uloženo.", false);
            } else {
                showStatus("Chyba: " + (data.message || "Neznámá chyba"), true);
            }
        }).catch(function (err) {
            showStatus("Chyba: " + err.message, true);
        }).then(function () {
            elSaveBtn.disabled = false;
            elSaveBtn.textContent = "Uložit";
        });
    });

    // Delete
    elDeleteBtn.addEventListener("click", function () {
        if (!editingName) return;
        if (!confirm('Opravdu smazat zařízení "' + editingName + '"?')) return;

        var deviceName = editingName;
        elDeleteBtn.disabled = true;
        elDeleteBtn.textContent = "Mazání...";

        apiFetch("devices/" + deviceName + ".txt").then(function (r) {
            if (!r.ok) throw new Error("Soubor nenalezen (HTTP " + r.status + ")");
            return r.json();
        }).then(function (data) {
            return apiFetch("devices/" + deviceName + ".txt", {
                method: "DELETE",
                body: JSON.stringify({
                    message: "Delete " + deviceName + ".txt",
                    sha: data.sha
                })
            });
        }).then(function (r) {
            if (!r.ok) {
                return r.json().then(function (d) {
                    throw new Error(d.message || "Nepodařilo se smazat");
                });
            }
            editingSha = null;
            editingName = "";
            hide(elEditor);
            show(elPanel);
            // Remove item from list immediately (optimistic)
            var items = elDeviceList.querySelectorAll(".device-list-item");
            for (var i = 0; i < items.length; i++) {
                if (items[i].textContent === deviceName) {
                    items[i].remove();
                    break;
                }
            }
            if (elDeviceList.children.length === 0) {
                show(elListEmpty);
                hide(elExportBtn);
            }
        }).catch(function (err) {
            showStatus("Chyba při mazání: " + err.message, true);
        }).then(function () {
            elDeleteBtn.disabled = false;
            elDeleteBtn.textContent = "Smazat";
        });
    });

    // Back
    elBackBtn.addEventListener("click", closeEditor);

    // New device
    elNewBtn.addEventListener("click", function () { openEditor(null); });

    // Live preview + link update
    elDeviceContent.addEventListener("input", updatePreview);
    elDeviceIdInput.addEventListener("input", updateDeviceLink);

    // Copy link to clipboard
    elCopyLinkBtn.addEventListener("click", function () {
        var url = elDeviceLink.href;
        navigator.clipboard.writeText(url).then(function () {
            elCopyLinkBtn.title = "Zkopírováno!";
            elCopyLinkBtn.classList.add("copied");
            setTimeout(function () {
                elCopyLinkBtn.title = "Kopírovat do schránky";
                elCopyLinkBtn.classList.remove("copied");
            }, 1500);
        });
    });

    // Export all devices as ZIP
    elExportBtn.addEventListener("click", function () {
        elExportBtn.disabled = true;
        elExportBtn.textContent = "Exportování...";

        apiFetch("devices").then(function (r) {
            if (!r.ok) throw new Error("HTTP " + r.status);
            return r.json();
        }).then(function (files) {
            var txtFiles = files.filter(function (f) { return f.name.endsWith(".txt"); });
            return Promise.all(txtFiles.map(function (f) {
                return apiFetch("devices/" + f.name).then(function (r) {
                    if (!r.ok) throw new Error("HTTP " + r.status + " for " + f.name);
                    return r.json();
                }).then(function (data) {
                    if (!data.content) return { name: f.name, text: "" };
                    return decodeFileContent(data).then(function (text) {
                        return { name: f.name, text: text };
                    });
                });
            }));
        }).then(function (devices) {
            var zip = new JSZip();
            devices.forEach(function (d) {
                var data = S2DtRH.parseDeviceData(d.text);
                var formatted = JSON.stringify(data, null, "\t");
                zip.file(d.name, formatted);
            });
            return zip.generateAsync({ type: "blob" });
        }).then(function (blob) {
            var now = new Date();
            var stamp = now.getFullYear() + "-" +
                String(now.getMonth() + 1).padStart(2, "0") + "-" +
                String(now.getDate()).padStart(2, "0") + "-" +
                String(now.getHours()).padStart(2, "0") + "-" +
                String(now.getMinutes()).padStart(2, "0");
            var a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = stamp + "-Devices-backup.zip";
            a.click();
            URL.revokeObjectURL(a.href);
        }).catch(function (err) {
            alert("Export selhal: " + err.message);
        }).then(function () {
            elExportBtn.disabled = false;
            elExportBtn.textContent = "Export zálohy (.zip)";
        });
    });

    // Import from ZIP
    elImportBtn.addEventListener("click", function () {
        elImportFile.click();
    });

    elImportFile.addEventListener("change", function () {
        var file = elImportFile.files[0];
        if (!file) return;
        elImportFile.value = "";

        if (!confirm("Importovat zálohu? Existující soubory se přepíší.")) return;

        elImportBtn.disabled = true;
        elImportBtn.textContent = "Importování...";

        var existingFiles = {};

        apiFetch("devices").then(function (r) {
            if (r.status === 404) return [];
            return r.json();
        }).then(function (files) {
            if (Array.isArray(files)) {
                files.forEach(function (f) {
                    if (f.name.endsWith(".txt")) existingFiles[f.name] = f.sha;
                });
            }
            return JSZip.loadAsync(file);
        }).then(function (zip) {
            var tasks = [];
            zip.forEach(function (path, entry) {
                if (entry.dir) return;
                var name = path.split("/").pop();
                if (!name.endsWith(".txt")) return;
                tasks.push(
                    entry.async("string").then(function (text) {
                        return { name: name, text: text };
                    })
                );
            });
            return Promise.all(tasks);
        }).then(function (entries) {
            var chain = Promise.resolve();
            var imported = 0;
            entries.forEach(function (entry) {
                chain = chain.then(function () {
                    return S2DtRH.encrypt(entry.text).then(function (encrypted) {
                        var body = {
                            message: "Import " + entry.name,
                            content: btoa(encrypted)
                        };
                        if (existingFiles[entry.name]) body.sha = existingFiles[entry.name];
                        return apiFetch("devices/" + entry.name, {
                            method: "PUT",
                            body: JSON.stringify(body)
                        });
                    }).then(function (r) {
                        if (!r.ok) {
                            return r.json().then(function (d) {
                                throw new Error(entry.name + ": " + (d.message || "Chyba"));
                            });
                        }
                        imported++;
                        elImportBtn.textContent = "Importováno " + imported + "/" + entries.length + "...";
                    });
                });
            });
            return chain;
        }).then(function () {
            loadDeviceList();
            alert("Import dokončen.");
        }).catch(function (err) {
            alert("Import selhal: " + err.message);
            loadDeviceList();
        }).then(function () {
            elImportBtn.disabled = false;
            elImportBtn.textContent = "Import zálohy (.zip)";
        });
    });

    // Login
    elLoginForm.addEventListener("submit", function (e) {
        e.preventDefault();
        hide(elLoginError);
        var pass = elAdminPass.value;
        githubPat = elGithubPat.value.trim();

        if (!githubPat) {
            elLoginError.textContent = "Zadejte GitHub PAT.";
            show(elLoginError);
            return;
        }

        S2DtRH.sha256(pass).then(function (hash) {
            if (hash === S2DtRH.ADMIN_HASH) {
                hide(elLogin);
                show(elPanel);
                loadDeviceList();
            } else {
                elLoginError.textContent = "Neplatné heslo.";
                show(elLoginError);
                elAdminPass.value = "";
                elAdminPass.focus();
            }
        });
    });
})();
</script>

</body>
</html>
